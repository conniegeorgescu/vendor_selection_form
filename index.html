import React, { useState } from 'react';
import { Download, CheckCircle, AlertCircle } from 'lucide-react';

const VendorSelectionForm = () => {
  const vendors = [
    'APC', 'Avast', 'Fellowes', 'HP', 'iStorage', 'Lenovo', 
    'Logitech', 'Philips', 'Samsung Mobile', 'Synology', 'TP Link'
  ];

  const salesTeam = [
    'Adam Iqbal', 'Arran Bal', 'Clare Douglas', 'David Holland', 'David Matthews',
    'David Walshe', 'Elliott Yates', 'Hasan Haideri', 'Jason Curtis', 'Jat Tumber',
    'Jenny Hodson', 'Jonathan Ashfall', 'Jon Garvey', 'Karen Burton', 'Keane Richards',
    'Klaudia Borun', 'Madison Moss-Williams', 'Mat Pyle', 'Michael Addinell', 'Michael Doherty',
    'Mike Leigh', 'Nourelhuda El Magbari', 'Paul Rennals', 'Paul Sellers', 'Ray Parmar',
    'Rourke Smal', 'Scott Hancock', 'Sarah Lyons', 'Tom Bestwick', 'Zahid Hussain'
  ];

  const [selectedName, setSelectedName] = useState('');
  const [selectedVendors, setSelectedVendors] = useState([]);
  const [submissions, setSubmissions] = useState([]);
  const [showSuccess, setShowSuccess] = useState(false);

  const handleVendorToggle = (vendor) => {
    if (selectedVendors.includes(vendor)) {
      setSelectedVendors(selectedVendors.filter(v => v !== vendor));
    } else {
      setSelectedVendors([...selectedVendors, vendor]);
    }
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (selectedName && selectedVendors.length >= 5) {
      setSubmissions([...submissions, {
        name: selectedName,
        vendors: [...selectedVendors],
        timestamp: new Date().toLocaleString()
      }]);
      setSelectedName('');
      setSelectedVendors([]);
      setShowSuccess(true);
      setTimeout(() => setShowSuccess(false), 3000);
    }
  };

  const exportToCSV = (format) => {
    let csvContent = '';
    
    if (format === 'by-person') {
      // Find max number of vendors selected by anyone
      const maxVendors = Math.max(...submissions.map(s => s.vendors.length));
      
      // Create header
      const headers = ['Name'];
      for (let i = 1; i <= maxVendors; i++) {
        headers.push(`Vendor ${i}`);
      }
      headers.push('Timestamp');
      csvContent = headers.join(',') + '\n';
      
      // Add rows
      submissions.forEach(sub => {
        const row = [sub.name, ...sub.vendors];
        // Fill empty cells if this person selected fewer than max
        while (row.length < maxVendors + 1) {
          row.push('');
        }
        row.push(sub.timestamp);
        csvContent += row.join(',') + '\n';
      });
    } else {
      csvContent = 'Vendor,Visitor Count,Visitors\n';
      const vendorMap = {};
      
      vendors.forEach(vendor => {
        vendorMap[vendor] = [];
      });
      
      submissions.forEach(sub => {
        sub.vendors.forEach(vendor => {
          vendorMap[vendor].push(sub.name);
        });
      });
      
      Object.keys(vendorMap).sort().forEach(vendor => {
        const visitors = vendorMap[vendor];
        csvContent += `${vendor},${visitors.length},"${visitors.join('; ')}"\n`;
      });
    }
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = format === 'by-person' ? 'vendor-selections-by-person.csv' : 'vendor-selections-by-vendor.csv';
    a.click();
  };

  const getVendorVisitors = () => {
    const vendorMap = {};
    vendors.forEach(vendor => {
      vendorMap[vendor] = [];
    });
    
    submissions.forEach(sub => {
      sub.vendors.forEach(vendor => {
        vendorMap[vendor].push(sub.name);
      });
    });
    
    return vendorMap;
  };

  const vendorVisitors = getVendorVisitors();

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-xl shadow-lg p-8 mb-6">
          <h1 className="text-3xl font-bold text-gray-800 mb-2">Vendor Selection Form</h1>
          <p className="text-gray-600 mb-6">Select at least 5 vendors you'd like to meet (you can select more)</p>
          
          {showSuccess && (
            <div className="mb-6 bg-green-50 border border-green-200 rounded-lg p-4 flex items-center gap-3">
              <CheckCircle className="text-green-600" size={24} />
              <span className="text-green-800 font-medium">Selection submitted successfully!</span>
            </div>
          )}

          <div onSubmit={handleSubmit}>
            <div className="mb-6">
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Your Name *
              </label>
              <select
                value={selectedName}
                onChange={(e) => setSelectedName(e.target.value)}
                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                required
              >
                <option value="">-- Select your name --</option>
                {salesTeam.map(name => (
                  <option key={name} value={name}>{name}</option>
                ))}
              </select>
            </div>

            <div className="mb-6">
              <div className="flex justify-between items-center mb-3">
                <label className="block text-sm font-semibold text-gray-700">
                  Select Vendors (minimum 5) *
                </label>
                <span className={`text-sm font-medium ${selectedVendors.length >= 5 ? 'text-green-600' : 'text-gray-500'}`}>
                  {selectedVendors.length} selected {selectedVendors.length >= 5 && 'âœ“'}
                </span>
              </div>
              
              <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                {vendors.map(vendor => {
                  const isSelected = selectedVendors.includes(vendor);
                  
                  return (
                    <button
                      key={vendor}
                      type="button"
                      onClick={() => handleVendorToggle(vendor)}
                      className={`p-4 rounded-lg border-2 transition-all ${
                        isSelected
                          ? 'border-indigo-500 bg-indigo-50 text-indigo-700 font-semibold'
                          : 'border-gray-300 bg-white hover:border-indigo-300 hover:bg-indigo-50'
                      }`}
                    >
                      {vendor}
                    </button>
                  );
                })}
              </div>
            </div>

            {selectedVendors.length > 0 && selectedVendors.length < 5 && (
              <div className="mb-6 bg-amber-50 border border-amber-200 rounded-lg p-4 flex items-center gap-3">
                <AlertCircle className="text-amber-600" size={20} />
                <span className="text-amber-800 text-sm">
                  Please select at least 5 vendors ({5 - selectedVendors.length} more needed)
                </span>
              </div>
            )}

            <button
              type="button"
              onClick={handleSubmit}
              disabled={!selectedName || selectedVendors.length < 5}
              className="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
            >
              Submit Selection
            </button>
          </div>
        </div>

        {submissions.length > 0 && (
          <>
            <div className="bg-white rounded-xl shadow-lg p-8 mb-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold text-gray-800">
                  Submissions ({submissions.length})
                </h2>
                <div className="flex gap-3">
                  <button
                    onClick={() => exportToCSV('by-person')}
                    className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
                  >
                    <Download size={18} />
                    Export by Person
                  </button>
                  <button
                    onClick={() => exportToCSV('by-vendor')}
                    className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    <Download size={18} />
                    Export by Vendor
                  </button>
                </div>
              </div>

              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="bg-gray-50 border-b">
                      <th className="text-left p-3 font-semibold text-gray-700">Name</th>
                      <th className="text-left p-3 font-semibold text-gray-700">Vendors Selected</th>
                      <th className="text-left p-3 font-semibold text-gray-700">Count</th>
                      <th className="text-left p-3 font-semibold text-gray-700">Time</th>
                    </tr>
                  </thead>
                  <tbody>
                    {submissions.map((sub, idx) => (
                      <tr key={idx} className="border-b hover:bg-gray-50">
                        <td className="p-3 font-medium">{sub.name}</td>
                        <td className="p-3 text-gray-700">{sub.vendors.join(', ')}</td>
                        <td className="p-3 text-gray-600">{sub.vendors.length}</td>
                        <td className="p-3 text-gray-500 text-sm">{sub.timestamp}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            <div className="bg-white rounded-xl shadow-lg p-8">
              <h2 className="text-2xl font-bold text-gray-800 mb-6">Vendor Visitor Summary</h2>
              <div className="space-y-4">
                {Object.entries(vendorVisitors).sort().map(([vendor, visitors]) => (
                  <div key={vendor} className="border-l-4 border-indigo-500 pl-4 py-2">
                    <h3 className="font-bold text-lg text-gray-800 mb-1">
                      {vendor} <span className="text-sm text-gray-500">({visitors.length} visitors)</span>
                    </h3>
                    <p className="text-gray-700">
                      {visitors.length > 0 ? visitors.join(', ') : 'No visitors yet'}
                    </p>
                  </div>
                ))}
              </div>
            </div>
          </>
        )}
      </div>
    </div>
  );
};

export default VendorSelectionForm;
